# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  solution: '**/Medja.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

steps:
- task: NuGetToolInstaller@1
  displayName: Install NuGet latest

- task: DotNetCoreInstaller@1
  displayName: Install dotnet core sdk 3.0.x
  inputs:
    packageType: 'sdk'
    version: '3.0.x'

- task: NuGetCommand@2
  displayName: Restore NuGet packages
  inputs:
    restoreSolution: '$(solution)'
    vstsFeed: '49e07518-6419-486d-9ec2-aea3f61f1ded'

- task: DotNetCoreCLI@2
  displayName: Build Medja.sln
  inputs:
    command: build
    projects: '$(solution)'
    arguments: '--configuration $(buildConfiguration)'

- task: DotNetCoreCLI@2
  displayName: 'dotnet test'
  inputs:
    command: test
    projects: '$(solution)'
    arguments: '--configuration $(buildConfiguration)'
    publishTestResults: true

- task: DotNetCoreCLI@2
  displayName: 'dotnet pack'
  inputs:
    command: pack
    packagesToPack: '**/Medja.Utils/*.csproj; **/Medja/*.csproj; **/Medja.ZeroMQ/*.csproj; **/Medja.ProtoBuf/*.csproj; **/Medja.OpenTk/*.csproj; **/Medja.OpenTk.Themes/*.csproj; **/Medja.Properties/*.csproj'
    versioningScheme: byPrereleaseNumber # uses date and time + following fields
    majorVersion: 0
    minorVersion: 9
    patchVersion: 1

- task: NuGetCommand@2
  displayName: 'NuGet push'
  inputs:
    command: push
    publishVstsFeed: '49e07518-6419-486d-9ec2-aea3f61f1ded'

- task: CopyFiles@2
  displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
  inputs:
    SourceFolder: '$(system.defaultworkingdirectory)'
    Contents: '**\bin\$(BuildConfiguration)\**'
    TargetFolder: '$(build.artifactstagingdirectory)'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)'

# not working on linux machines - seems to be windows only
#- task: PublishSymbols@2
#  displayName: 'Publish symbols path'
#  inputs:
#    SearchPattern: '**\bin\**\*.pdb'
#    SymbolServerType: TeamServices
#    DetailedLog: false
#    TreatNotIndexedAsWarning: true
#  continueOnError: true